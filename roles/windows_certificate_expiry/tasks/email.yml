---
- name: Send email | Share report and worknotes without failing playbook
  run_once: true
  delegate_to: localhost
  block:
    - name: Send email | Share report and worknotes
      community.general.mail:
        host: "{{ smtp_host }}"
        port: "{{ smtp_port }}"
        from: "{{ email_from }}"
        to: "{{ email_to | join(',') }}"
        subject: "{{ email_subject }}"
        subtype: plain
        body: |
          Hello Team,

          Please find the Windows certificate expiry report and worknotes attached.

          Summary:
          - Target hosts: {{ ansible_play_hosts_all | length }}
          - Expiry threshold (days): {{ cert_days_threshold }}
          - Report file: {{ report_file_result.dest }}
          - Worknotes file: {{ worknotes_file_result.dest }}

          Regards,
          Ansible Automation
        attach:
          - "{{ report_file_result.dest }}"
          - "{{ worknotes_file_result.dest }}"

    - name: Send email | Capture success worknote
      ansible.builtin.debug:
        msg: "SUCCESS: Email sent with report and worknotes."

  rescue:
    - name: Send email | Warn when email delivery fails but continue
      ansible.builtin.debug:
        msg: "WARNING: Email delivery failed. Please verify SMTP settings."
